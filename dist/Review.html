<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reviewer Console | DrawbackFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .nav-item.active { background-color: #EFF6FF; color: #2563EB; border-right: 3px solid #2563EB; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid #2563EB; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast { visibility: hidden; min-width: 250px; background-color: #1e293b; color: #fff; text-align: center; border-radius: 8px; padding: 12px 24px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transition: all 0.3s; }
        #toast.show { visibility: visible; bottom: 40px; opacity: 1; }
        #toast.error { background-color: #EF4444; } #toast.success { background-color: #10B981; } #toast.warning { background-color: #F59E0B; color: #fff; }
        .edit-input { width: 100%; background: transparent; padding: 4px; border-radius: 4px; border: 1px solid transparent; transition: all 0.2s; }
        .edit-input:hover { border-color: #cbd5e1; background: #fff; }
        .edit-input:focus { border-color: #3b82f6; background: #fff; outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        .smart-note { font-size: 0.7rem; color: #d97706; background: #fef3c7; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; white-space: nowrap; border: 1px solid #fcd34d; }
        .status-badge { padding: 2px 8px; border-radius: 999px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; }
        .status-draft { background-color: #e2e8f0; color: #475569; }
        .error-row { background-color: #fee2e2 !important; }
        .warning-row { background-color: #fffbeb !important; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        th { font-weight: 600; color: #475569; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; background-color: #F8FAFC; white-space: nowrap; padding: 12px 8px; border-bottom: 2px solid #E2E8F0; }
        td { white-space: nowrap; padding: 8px; vertical-align: middle; }
        .detail-label { font-size: 0.65rem; color: #94a3b8; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px; }
        .detail-value { font-size: 0.875rem; color: #334155; font-weight: 500; min-height: 1.25rem; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden">

    <div id="toast">Notification</div>

    <div id="loading-overlay">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-slate-600 font-semibold text-sm" id="loader-text">Processing...</p>
        </div>
    </div>

    <div id="details-modal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-7xl h-[95vh] flex flex-col animate-fadeIn overflow-hidden">
            <div class="flex justify-between items-center p-5 border-b border-gray-100 bg-slate-50">
                <div>
                    <h3 class="text-xl font-bold text-slate-800"><i class="fa-solid fa-scale-balanced mr-2 text-blue-600"></i>Match Details</h3>
                    <p class="text-xs text-slate-500 mt-1">Match UUID: <span id="det-uuid" class="font-mono text-slate-700 bg-slate-200 px-1 rounded">...</span></p>
                </div>
                <button onclick="document.getElementById('details-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-700 text-2xl"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 bg-slate-100">
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-sm border border-blue-200 overflow-hidden">
                        <div class="bg-blue-50 px-4 py-3 border-b border-blue-100 flex justify-between items-center">
                            <span class="font-bold text-blue-800 text-sm uppercase"><i class="fa-solid fa-plane-departure mr-2"></i>Export Record</span>
                            <span class="text-xs text-blue-600 bg-white px-2 py-1 rounded border border-blue-100 font-mono" id="det-exp-entry">...</span>
                        </div>
                        <div class="p-5 grid grid-cols-2 gap-y-5 gap-x-4 text-sm">
                            <div class="col-span-2"><div class="detail-label">Material Number</div><div id="det-exp-sku" class="text-lg font-bold text-slate-800"></div></div>
                            <div><div class="detail-label">Quantity</div><div id="det-exp-qty" class="font-bold"></div></div>
                            <div><div class="detail-label">UOM</div><div id="det-exp-uom"></div></div>
                            <div><div class="detail-label">Export Date</div><div id="det-exp-date"></div></div>
                            <div><div class="detail-label">Country</div><div id="det-exp-country"></div></div>
                            <div class="col-span-2 border-t border-dashed border-slate-100"></div>
                            <div><div class="detail-label">Invoice No</div><div id="det-exp-inv"></div></div>
                            <div><div class="detail-label">Internal ID</div><div id="det-exp-id"></div></div>
                            <div class="col-span-2"><div class="detail-label">Description</div><div id="det-exp-desc" class="text-xs text-slate-500 italic bg-slate-50 p-2 rounded border border-slate-100"></div></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border border-emerald-200 overflow-hidden">
                        <div class="bg-emerald-50 px-4 py-3 border-b border-emerald-100 flex justify-between items-center">
                            <span class="font-bold text-emerald-800 text-sm uppercase"><i class="fa-solid fa-ship mr-2"></i>Matched Import</span>
                            <span class="text-xs text-emerald-600 bg-white px-2 py-1 rounded border border-emerald-100 font-mono" id="det-imp-entry">...</span>
                        </div>
                        <div class="p-5 grid grid-cols-3 gap-y-5 gap-x-4 text-sm">
                            <div class="col-span-2"><div class="detail-label">Import Material</div><div id="det-imp-sku" class="text-lg font-bold text-slate-800"></div></div>
                            <div><div class="detail-label">Import Date</div><div id="det-imp-date"></div></div>
                            <div><div class="detail-label">Declaration #</div><div id="det-imp-dec"></div></div>
                            <div><div class="detail-label">Line Number</div><div id="det-imp-line"></div></div>
                            <div><div class="detail-label">HTS Code</div><div id="det-imp-hts"></div></div>
                            <div class="col-span-3 border-t border-dashed border-slate-100"></div>
                            <div><div class="detail-label">Original Qty</div><div id="det-imp-orig"></div></div>
                            <div><div class="detail-label">Available Qty</div><div id="det-imp-avail"></div></div>
                            <div><div class="detail-label">UOM</div><div id="det-imp-uom"></div></div>
                            <div class="col-span-3 border-t border-dashed border-slate-100"></div>
                            <div><div class="detail-label">Customs Value (Total)</div><div id="det-imp-val"></div></div>
                            <div><div class="detail-label">Duty Paid</div><div id="det-imp-paid"></div></div>
                            <div><div class="detail-label">Duty Rate</div><div id="det-imp-rate" class="font-bold text-slate-900"></div></div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 bg-white rounded-lg shadow-sm border border-slate-200 p-5">
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-4 border-b border-slate-100 pb-2">Match Logic & Calculation Breakdown</h4>
                    <div class="grid grid-cols-7 gap-4 text-center">
                        <div class="bg-slate-50 p-3 rounded border border-slate-100"><div class="detail-label">Algorithm</div><div id="det-algo" class="font-bold text-blue-600"></div></div>
                        <div class="bg-slate-50 p-3 rounded border border-slate-100"><div class="detail-label">Consumed Qty</div><div id="det-match-qty" class="font-bold text-slate-800 text-lg"></div></div>
                        <div class="bg-indigo-50 p-3 rounded border border-indigo-100"><div class="detail-label">Entered Value</div><div id="det-entered-val" class="font-bold text-indigo-700 text-lg"></div></div>
                        <div class="bg-orange-50 p-3 rounded border border-orange-100"><div class="detail-label">Export Duty (100%)</div><div id="det-export-duty" class="font-bold text-orange-700 text-lg"></div></div>
                        <div class="bg-emerald-50 p-3 rounded border border-emerald-100"><div class="detail-label">99% Duty</div><div id="det-99-duty" class="font-bold text-emerald-700 text-lg"></div></div>
                        <div class="bg-slate-50 p-3 rounded border border-slate-100"><div class="detail-label">Total Refund</div><div id="det-total-refund" class="font-bold text-slate-700 text-xl"></div></div>
                        <div class="bg-slate-50 p-3 rounded border border-slate-100"><div class="detail-label">Status</div><div id="det-status"></div></div>
                    </div>
                    <div class="mt-4 text-xs text-slate-500 bg-yellow-50 p-3 rounded border border-yellow-100"><i class="fa-solid fa-circle-info mr-1 text-yellow-600"></i> <span id="det-notes"></span></div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-white flex justify-end gap-3">
                <button onclick="document.getElementById('details-modal').classList.add('hidden')" class="px-6 py-2 bg-slate-100 text-slate-600 rounded hover:bg-slate-200 font-medium transition">Close</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl w-96 p-6 animate-fadeIn">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Edit Match Record</h3>
            <input type="hidden" id="edit-match-id">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Matched SKU</label>
            <input type="text" id="edit-sku" disabled class="w-full bg-slate-100 border border-slate-300 rounded p-2 text-sm mb-3">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Refund Amount ($)</label>
            <input type="number" id="edit-refund" step="0.01" class="w-full border border-slate-300 rounded p-2 text-sm mb-3 focus:border-blue-500 outline-none">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Reviewer Notes</label>
            <textarea id="edit-notes" rows="3" class="w-full border border-slate-300 rounded p-2 text-sm mb-4 focus:border-blue-500 outline-none"></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="px-3 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded">Cancel</button>
                <button onclick="saveMatchEdit()" class="px-3 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded font-bold">Save Changes</button>
            </div>
        </div>
    </div>

    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col shadow-lg z-20">
        <div class="h-16 flex items-center px-6 border-b border-gray-100">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white mr-3"><i class="fa-solid fa-layer-group"></i></div>
            <!-- <div>
                <span class="font-bold text-lg tracking-tight block">DrawbackFlow</span>
                <span class="text-[10px] font-bold text-blue-600 uppercase tracking-widest">Reviewer</span>
            </div> -->
        </div>
        <nav class="flex-1 py-6 space-y-1 overflow-y-auto">
            <div class="px-6 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Analytics</div>
            <a href="#" onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item active flex items-center px-6 py-3 text-slate-600 hover:bg-blue-50 transition-all cursor-pointer"><i class="fa-solid fa-chart-pie w-5 mr-2"></i> <span class="font-medium">Dashboard</span></a>

            <div class="px-6 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 mt-6">Data Management</div>
            <a href="#" onclick="switchView('products')" id="nav-products" class="nav-item flex items-center px-6 py-3 text-slate-600 hover:bg-blue-50 transition-all cursor-pointer"><i class="fa-solid fa-box w-5 mr-2"></i> <span class="font-medium">Product Master</span></a>
            <a href="#" onclick="switchView('material_mappings')" id="nav-material_mappings" class="nav-item flex items-center px-6 py-3 text-slate-600 hover:bg-blue-50 transition-all cursor-pointer"><i class="fa-solid fa-link w-5 mr-2"></i> <span class="font-medium">Mappings</span></a>
            <a href="#" onclick="switchView('imports')" id="nav-imports" class="nav-item flex items-center px-6 py-3 text-slate-600 hover:bg-blue-50 transition-all cursor-pointer"><i class="fa-solid fa-ship w-5 mr-2"></i> <span class="font-medium">Imports</span></a>
            <a href="#" onclick="switchView('exports')" id="nav-exports" class="nav-item flex items-center px-6 py-3 text-slate-600 hover:bg-blue-50 transition-all cursor-pointer"><i class="fa-solid fa-plane-departure w-5 mr-2"></i> <span class="font-medium">Exports</span></a>

            <div class="px-6 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 mt-6">Process</div>
            <a href="#" onclick="switchView('matching')" id="nav-matching" class="nav-item flex items-center px-6 py-3 text-slate-600 hover:bg-blue-50 transition-all cursor-pointer"><i class="fa-solid fa-wand-magic-sparkles w-5 mr-2"></i> <span class="font-medium">Matching Engine</span></a>
            <a href="#" onclick="switchView('reviewer')" id="nav-reviewer" class="nav-item flex items-center px-6 py-3 text-slate-600 hover:bg-blue-50 transition-all cursor-pointer"><i class="fa-solid fa-magnifying-glass w-5 mr-2"></i> <span class="font-medium">Reviewer Console</span></a>
            <a href="#" onclick="switchView('history')" id="nav-history" class="nav-item flex items-center px-6 py-3 text-slate-600 hover:bg-blue-50 transition-all cursor-pointer"><i class="fa-solid fa-clock-rotate-left w-5 mr-2"></i> <span class="font-medium">History</span></a>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative bg-slate-50">
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 shadow-sm z-30">
            <h2 id="page-title" class="text-xl font-bold text-slate-800">Dashboard</h2>
            <div class="flex gap-3">
                <div class="text-xs font-bold text-blue-700 bg-blue-100 px-3 py-2 rounded">ROLE: REVIEWER</div>
                <button onclick="resetSystem()" class="px-4 py-2 bg-red-50 text-red-600 rounded-lg text-sm font-medium hover:bg-red-100 border border-red-200 transition">Reset DB</button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8" id="content-area">

            <div id="view-dashboard" class="view-section fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-blue-50 rounded-full -mr-10 -mt-10"></div>
                        <span class="text-xs font-bold text-slate-400 uppercase relative z-10">Unclaimed Potential</span>
                        <h3 class="text-3xl font-bold text-slate-800 mt-2 relative z-10" id="stat-potential">...</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-emerald-50 rounded-full -mr-10 -mt-10"></div>
                        <span class="text-xs font-bold text-slate-400 uppercase relative z-10">Recovered Duty</span>
                        <h3 class="text-3xl font-bold text-emerald-600 mt-2 relative z-10" id="stat-recovered">...</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <span class="text-xs font-bold text-slate-400 uppercase">System Stats</span>
                        <div class="flex justify-between mt-3 text-sm"><span class="text-slate-600">Import Entries</span><span class="font-bold text-slate-800" id="count-imports">-</span></div>
                        <div class="flex justify-between mt-2 text-sm"><span class="text-slate-600">Export Entries</span><span class="font-bold text-slate-800" id="count-exports">-</span></div>
                    </div>
                </div>
            </div>

            <div id="view-management" class="view-section hidden fade-in">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 p-6">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-700 text-lg">Manage <span id="mgmt-title">Data</span></h3></div>
                    <div class="border-2 border-dashed border-slate-200 rounded-lg p-8 text-center hover:border-blue-400 hover:bg-blue-50 transition cursor-pointer relative group">
                        <input type="file" id="file-input" accept=".xlsx, .xls, .csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileUpload()">
                        <div class="pointer-events-none">
                            <i class="fa-solid fa-cloud-upload text-4xl text-slate-300 mb-3 group-hover:text-blue-500 transition"></i>
                            <p class="text-sm font-medium text-slate-600">Click to upload Data File</p>
                        </div>
                    </div>
                    <div id="staged-preview" class="hidden mt-6 border-t border-slate-100 pt-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-slate-700">Review</h4>
                            <div class="flex gap-2">
                                <button onclick="resetUpload()" class="px-3 py-2 text-sm text-slate-500 hover:text-slate-800">Cancel</button>
                                <button id="btn-commit" onclick="commitData()" class="px-4 py-2 text-sm bg-green-600 text-white rounded font-medium">Commit to DB</button>
                            </div>
                        </div>
                        <div class="bg-slate-50 rounded border border-slate-200 overflow-hidden"><div class="overflow-x-auto max-h-[300px]"><table class="min-w-full text-xs text-left"><thead class="bg-slate-100 text-slate-500 sticky top-0 z-10"><tr id="preview-header"></tr></thead><tbody id="preview-body" class="bg-white divide-y divide-slate-100"></tbody></table></div></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-6 py-3 border-b border-slate-100 bg-slate-50 flex items-center justify-between"><span class="font-bold text-slate-600 text-sm">Records</span><input type="text" id="table-search" onkeyup="filterTable('data-table', 1)" placeholder="Search..." class="text-xs p-2 border rounded w-48 outline-none"></div>
                    <div class="overflow-x-auto max-h-[600px]"><table class="min-w-full divide-y divide-slate-200 text-sm" id="data-table"><thead class="bg-slate-50 sticky top-0 shadow-sm z-10"></thead><tbody class="divide-y divide-slate-100 bg-white"></tbody></table></div>
                </div>
            </div>

            <div id="view-matching" class="view-section hidden fade-in">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                    <h3 class="font-bold text-slate-800 mb-4">Matching Logic</h3>
                    <div class="flex gap-4 mb-6">
                        <label class="flex-1 border p-4 rounded hover:bg-slate-50 cursor-pointer"><input type="radio" name="algo" value="FIFO" checked> <span class="font-bold ml-2">FIFO</span></label>
                        <label class="flex-1 border p-4 rounded hover:bg-slate-50 cursor-pointer"><input type="radio" name="algo" value="MAX_RECOVERY"> <span class="font-bold ml-2">Maximize Duty</span></label>
                    </div>
                    <button onclick="runMatching()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-md transition">Execute Matching Transaction</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 font-bold">Transaction Results</div>
                    <div class="overflow-x-auto max-h-[600px]"><table class="min-w-full text-xs text-left"><thead class="bg-white text-slate-500 border-b sticky top-0"><tr><th>Imp Entry</th><th>Matched SKU</th><th>Refund</th><th>Status</th><th>View</th></tr></thead><tbody class="divide-y divide-slate-50" id="matches-body"><tr><td colspan="5" class="p-6 text-center text-slate-400">No matches run yet.</td></tr></tbody></table></div>
                </div>
            </div>

            <div id="view-reviewer" class="view-section hidden fade-in">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 bg-blue-50 flex justify-between items-center">
                        <h3 class="font-bold text-blue-800">Reviewer Queue</h3>
                        <div class="flex items-center gap-3">
                            <button onclick="processReviewerBulkAction()" class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 font-bold shadow-sm"><i class="fa-solid fa-paper-plane mr-1"></i> Submit Selected</button>
                            <button onclick="loadReviewerQueue()" class="text-sm bg-white border border-blue-200 text-blue-600 px-3 py-1 rounded hover:bg-blue-100"><i class="fa-solid fa-rotate mr-1"></i></button>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[600px]">
                        <table class="min-w-full text-xs text-left">
                            <thead class="bg-slate-50 text-slate-500 border-b sticky top-0 z-10">
                                <tr>
                                    <th class="w-8"><input type="checkbox" onchange="toggleReviewerSelectAll(this)"></th>
                                    <th>Imp Entry</th><th>Imp SKU</th><th>Exp Entry</th><th>Refund Amount</th><th>Status / Notes</th><th>Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50" id="reviewer-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-history" class="view-section hidden fade-in">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 bg-purple-50"><h3 class="font-bold text-purple-800">History</h3></div>
                    <div class="overflow-x-auto max-h-[600px]"><table class="min-w-full text-xs text-left"><thead class="bg-slate-50 text-slate-500 border-b sticky top-0 z-10"><tr><th>Imp Entry</th><th>Matched SKU</th><th>Refund</th><th>Approved By</th></tr></thead><tbody class="divide-y divide-slate-50" id="history-body"></tbody></table></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- DATA PERSISTENCE (LOCAL STORAGE) ---
        const INITIAL_DB = {
            products: [{id: '1', sku: 'RAW-STEEL-COIL', description: 'Raw Steel', uom: 'KG', duty_rate: '0.08'}],
            material_mappings: [],
            imports: [{id: '1', sku: 'RAW-STEEL-COIL', entry_number: 'IMP-001', qty: '5000', customs_value: '5000', duty_paid: '400', uom: 'KG', duty_rate_1: '0.08'}],
            exports: [{id: '1', sku: 'RAW-STEEL-COIL', entry_number: 'EXP-901', qty: '500', uom: 'KG', invoice_no: 'INV-A100'}],
            matches: []
        };
        function getDB() { return JSON.parse(localStorage.getItem('DRAWBACK_DB')) || INITIAL_DB; }
        function saveDB(db) { localStorage.setItem('DRAWBACK_DB', JSON.stringify(db)); }
        function resetSystem() { if(confirm("Clear Local DB?")) { localStorage.removeItem('DRAWBACK_DB'); location.reload(); } }
        function navigateToLibrary() {}

        // --- GLOBAL VARS ---
        let currentView = 'dashboard';
        let stagedData = [];
        let reviewerSelection = new Set();
        const TABLE_CONFIG = {
            imports: [{k:'entry_number',l:'Entry #'}, {k:'sku',l:'SKU'}, {k:'qty',l:'Qty'}, {k:'duty_paid',l:'Duty Paid'}],
            exports: [{k:'entry_number',l:'Entry #'}, {k:'sku',l:'SKU'}, {k:'qty',l:'Qty'}, {k:'invoice_no',l:'Invoice'}],
            products: [{k:'sku',l:'SKU'}, {k:'description',l:'Desc'}, {k:'uom',l:'UOM'}],
            material_mappings: [{k:'export_sku',l:'Export SKU'}, {k:'import_sku',l:'Import SKU'}]
        };

        // --- UTIL ---
        function toggleLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
        function formatMoney(v) { return "$" + parseFloat(v||0).toLocaleString(undefined,{minimumFractionDigits:2}); }
        function showToast(m, t='success') { const el = document.getElementById('toast'); el.innerText=m; el.className=`show ${t}`; setTimeout(()=>el.className='', 3000); }
        function escapeJSON(o) { return JSON.stringify(o).replace(/'/g,"&#39;").replace(/"/g,"&quot;"); }

        // --- NAVIGATION ---
        function switchView(view) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById(`nav-${view}`).classList.add('active');
            document.getElementById('page-title').innerText = view.charAt(0).toUpperCase() + view.slice(1);

            if(view === 'dashboard') { document.getElementById('view-dashboard').classList.remove('hidden'); loadStats(); }
            else if(view === 'matching') { document.getElementById('view-matching').classList.remove('hidden'); }
            else if(view === 'reviewer') { document.getElementById('view-reviewer').classList.remove('hidden'); loadReviewerQueue(); }
            else if(view === 'history') { document.getElementById('view-history').classList.remove('hidden'); loadHistory(); }
            else {
                document.getElementById('view-management').classList.remove('hidden');
                document.getElementById('mgmt-title').innerText = view;
                loadTableData(view);
            }
            currentView = view;
        }

        // --- DASHBOARD STATS ---
        function loadStats() {
            const db = getDB();
            const potential = db.imports.reduce((acc, i) => acc + (parseFloat(i.duty_paid)||0), 0);
            const recovered = db.matches.filter(m => m.status === 'APPROVED').reduce((acc, m) => acc + m.refund_amount, 0);
            document.getElementById('stat-potential').innerText = formatMoney(potential);
            document.getElementById('stat-recovered').innerText = formatMoney(recovered);
            document.getElementById('count-imports').innerText = db.imports.length;
            document.getElementById('count-exports').innerText = db.exports.length;
        }

        // --- DATA MGMT ---
        function loadTableData(target) {
            const db = getDB();
            const data = db[target] || [];
            const tbody = document.querySelector('#data-table tbody');
            const thead = document.querySelector('#data-table thead');
            const config = TABLE_CONFIG[target];
            if(!config) return;
            thead.innerHTML = '<tr>' + config.map(c => `<th class="px-6 py-3">${c.l}</th>`).join('') + '</tr>';
            tbody.innerHTML = data.length ? data.map(r => `<tr>${config.map(c => `<td class="px-6 py-3">${r[c.k]}</td>`).join('')}</tr>`).join('') : '<tr><td colspan="4" class="p-4 text-center">No Data</td></tr>';
        }

        function handleFileUpload() {
            toggleLoading(true);
            setTimeout(() => {
                // SIMULATE PARSING
                if(currentView === 'imports') stagedData = [{sku: 'NEW-IMP', entry_number: 'IMP-'+Date.now(), qty: '1000', duty_paid: '100', uom: 'KG'}];
                else stagedData = [{sku: 'NEW-EXP', entry_number: 'EXP-'+Date.now(), qty: '200', uom: 'KG'}];

                // Render Preview
                document.getElementById('staged-preview').classList.remove('hidden');
                const tbody = document.getElementById('preview-body');
                const config = TABLE_CONFIG[currentView];
                document.getElementById('preview-header').innerHTML = config.map(c => `<th class="px-4 py-2">${c.l}</th>`).join('') + '<th>Status</th>';
                tbody.innerHTML = stagedData.map((r,i) => `<tr>${config.map(c => `<td class="p-2 border"><input value="${r[c.k]||''}" class="w-full"></td>`).join('')}<td class="text-green-600 font-bold p-2">OK</td></tr>`).join('');
                toggleLoading(false);
            }, 800);
        }

        function resetUpload() { stagedData = []; document.getElementById('staged-preview').classList.add('hidden'); }

        function commitData() {
            const db = getDB();
            db[currentView].push(...stagedData);
            saveDB(db);
            showToast("Saved to DB");
            resetUpload();
            loadTableData(currentView);
            loadStats();
        }

        // --- MATCHING ENGINE ---
        function runMatching() {
            toggleLoading(true);
            setTimeout(() => {
                const db = getDB();
                // MOCK MATCH ALGORITHM
                const match = {
                    match_id: 'M-'+Date.now(), match_uuid: 'UUID-'+Date.now(),
                    import_entry_number: 'IMP-001', import_sku: 'RAW-STEEL-COIL',
                    export_entry_number: 'EXP-901', export_sku: 'RAW-STEEL-COIL',
                    refund_amount: 150.00, status: 'DRAFT', notes: '',
                    qty_matched: 500, import_uom: 'KG',
                    import_qty_original: 5000, import_customs_val: 5000, import_duty_rate: 0.08,
                    export_qty_total: 500, export_uom: 'KG', export_invoice: 'INV-A100', export_country: 'CA'
                };
                db.matches.push(match);
                saveDB(db);

                document.getElementById('matches-body').innerHTML = db.matches.map(m => `
                    <tr><td>${m.import_entry_number}</td><td>${m.import_sku}</td><td>${formatMoney(m.refund_amount)}</td><td>${m.status}</td>
                    <td><button onclick='showMatchDetails(${escapeJSON(m)})' class="text-blue-600"><i class="fa-solid fa-eye"></i></button></td></tr>
                `).join('');

                toggleLoading(false);
                showToast("Matching Complete");
                loadStats();
            }, 1000);
        }

        // --- REVIEWER CONSOLE ---
        function loadReviewerQueue() {
            const db = getDB();
            const tbody = document.getElementById('reviewer-body');
            const data = db.matches.filter(m => m.status === 'DRAFT');
            reviewerSelection.clear();
            if(!data.length) tbody.innerHTML = `<tr><td colspan="7" class="p-6 text-center text-slate-400">Queue Empty</td></tr>`;
            else tbody.innerHTML = data.map(m => {
                let note = m.rejection_reason ? `<span class="text-red-600 font-bold">Returned: ${m.rejection_reason}</span>` : (m.notes || '-');
                return `
                <tr id="reviewer-row-${m.match_id}" class="${m.rejection_reason ? 'bg-red-50' : 'hover:bg-blue-50'} border-b">
                    <td class="p-3"><input type="checkbox" value="${m.match_id}" onchange="toggleReviewerSelection('${m.match_id}')"></td>
                    <td>${m.import_entry_number}</td><td>${m.import_sku}</td><td>${m.export_entry_number}</td>
                    <td class="font-bold text-slate-700">${formatMoney(m.refund_amount)}</td>
                    <td class="text-xs">${note}</td>
                    <td>
                        <button onclick='showMatchDetails(${escapeJSON(m)})' class="mr-2 text-slate-500"><i class="fa-solid fa-eye"></i></button>
                        <button onclick='openEditModal(${escapeJSON(m)})' class="text-blue-600"><i class="fa-solid fa-pen-to-square"></i></button>
                    </td>
                </tr>`;
            }).join('');
        }

        function toggleReviewerSelection(id) { if(reviewerSelection.has(id)) reviewerSelection.delete(id); else reviewerSelection.add(id); }
        function toggleReviewerSelectAll(src) { document.querySelectorAll('#reviewer-body input[type=checkbox]').forEach(c => { c.checked = src.checked; toggleReviewerSelection(c.value); }); }

        function processReviewerBulkAction() {
            if(!reviewerSelection.size) return showToast("Select items first", "warning");
            const db = getDB();
            let count = 0;
            db.matches.forEach(m => {
                if(reviewerSelection.has(m.match_id)) { m.status = 'REVIEWED'; m.rejection_reason = null; count++; }
            });
            saveDB(db);
            showToast(`Sent ${count} items to Approver`);
            loadReviewerQueue();
        }

        // --- EDIT MATCH ---
        function openEditModal(m) {
            document.getElementById('edit-match-id').value = m.match_id;
            document.getElementById('edit-sku').value = m.import_sku;
            document.getElementById('edit-refund').value = m.refund_amount;
            document.getElementById('edit-notes').value = m.notes || '';
            document.getElementById('edit-modal').classList.remove('hidden');
        }
        function saveMatchEdit() {
            const id = document.getElementById('edit-match-id').value;
            const db = getDB();
            const m = db.matches.find(x => x.match_id === id);
            if(m) {
                m.refund_amount = parseFloat(document.getElementById('edit-refund').value);
                m.notes = document.getElementById('edit-notes').value;
                saveDB(db);
                showToast("Updated");
                document.getElementById('edit-modal').classList.add('hidden');
                loadReviewerQueue();
            }
        }

        // --- DETAILS MODAL ---
        function showMatchDetails(m) {
            // Fill details
            document.getElementById('det-uuid').innerText = m.match_uuid;
            document.getElementById('det-imp-entry').innerText = m.import_entry_number;
            document.getElementById('det-exp-entry').innerText = m.export_entry_number;
            document.getElementById('det-total-refund').innerText = formatMoney(m.refund_amount);
            document.getElementById('det-status').innerText = m.status;
            // Calculations
            let enteredVal = (m.qty_matched / m.import_qty_original) * m.import_customs_val;
            let exportDuty = enteredVal * m.import_duty_rate;
            document.getElementById('det-entered-val').innerText = formatMoney(enteredVal);
            document.getElementById('det-export-duty').innerText = formatMoney(exportDuty);
            document.getElementById('det-99-duty').innerText = formatMoney(exportDuty * 0.99);
            document.getElementById('details-modal').classList.remove('hidden');
        }

        function loadHistory() {
             const db = getDB();
             const data = db.matches.filter(m => m.status === 'APPROVED');
             document.getElementById('history-body').innerHTML = data.map(m => `<tr><td class="p-3">${m.import_entry_number}</td><td>${m.import_sku}</td><td>${formatMoney(m.refund_amount)}</td><td>Admin</td></tr>`).join('');
        }

        // Init
        loadStats();
    </script>
</body>
</html>